function timeDriven(e){void 0!==e?errorHandling_(monitor_,!0):monitor_(!1)}function about(){if(loadOrDefaults_()){var e=UiApp.createApplication().setTitle(repl_(T.version,NAME,VERSION)).setWidth(340).setHeight(100);e.add(e.createScrollPanel().setSize("340px","100px").add(e.createVerticalPanel().setSpacing(3).setStyleAttribute("margin","10px").add(e.createLabel(repl_(T.about1,"Henrique G. Abreu"))).add(e.createLabel(T.about2)).add(e.createAnchor("http://sites.google.com/site/formemailer","http://sites.google.com/site/formemailer")))),SpreadsheetApp.getActiveSpreadsheet().show(e)}}function onOpen(){if(c.ss=c.ss||SpreadsheetApp.getActiveSpreadsheet(),c.cs=c.cs||c.ss.getSheetByName(NAME),null!=c.cs){try{loadConfig_(),c.ss.removeMenu(NAME+" ERROR"),c.ss.addMenu(NAME,[{name:T.menuSettings,functionName:"settings"},{name:T.menuManually,functionName:"processManually"},{name:T.menuAbout,functionName:"about"}])}catch(e){c.ss.removeMenu(NAME),c.ss.addMenu(NAME+" ERROR",[{name:T.menuFix,functionName:"fix"}])}checkTrigger_(!1)}else c.ss.addMenu(NAME,[{name:"Install",functionName:"install"}])}function onInstall(){onOpen()}function onEdit(e){c.ss=e.source,c.cs=c.ss.getSheetByName(NAME),null!=c.cs&&checkTrigger_(!1)}function monitor_(e){loadConfig_(),checkTrigger_(e);var t=c.fs.getLastRow();if(1==t)return null;for(var a=c.fs.getRange(2,1,t-1,1).getValues(),s=0;s<a.length;s++)""===a[s][0]&&doIt_(s+2)}function doIt_(e){for(var t=c.fs.getRange(e,2,1,c.size).getValues()[0],a={},r=0;r<t.length;r++)a[c.questions[r]]=t[r];if(c.fl)for(var n=c.fl.getRange(e,c.fc[0],1,c.fc[1]),i=n.setFormulasR1C1([c.formulas]).getValues()[0],r=0,o=c.fl===c.fs?c.fc[0]-2:t.length;r<i.length;++r,++o)a[c.questions[o]]=i[r];for(var l=[],r=0;r<s.qtt;++r){if(!(s.quota>s.qLimit)){l.push(T.statusQuota),0!=c.err.length&&startsWith_(c.err[c.err.length-1],T.statusQuota)||c.err.push(T.statusQuota+". "+new Date);break}try{for(var u={},p="true"==s["html"+r],o=0;o<ef.length-1;++o){var d=s[ef[o]+r].split("#");u[ef[o]]=d[0];for(var g=1;g<d.length;g+=2)u[ef[o]]+=(""!=d[g]?format_(a,d[g],l,p):"#")+d[g+1]}if(""==u.to){l.push(repl_(T.statusNot,1==s.qtt?"":r+1));continue}var h={name:u.sender,cc:u.cc,bcc:u.bcc};p&&(h.htmlBody=u.body),"noReply"==u.replyTo?h.noReply=!0:""!=u.replyTo&&(h.replyTo=u.replyTo),MailApp.sendEmail(u.to,u.subject,p?"html":u.body,h),l.push(repl_(T.statusEmail,1==s.qtt?"":r+1));var m=[""!=u.cc||""!=u.bcc?",":"",""!=u.cc&&""!=u.bcc?",":""];s.quota-=(u.to+m[0]+u.cc+m[1]+u.bcc).replace(/"[^"]*"/g,"").split(/,/).length}catch(f){l.push(repl_(T.statusError,1==s.qtt?"":r+1,f)),c.err.push(repl_(T.mailError,1==s.qtt?"":r+1,f,e))}}c.fs.getRange(e,1).setValue(l.join("; ")),c.fl&&2!=e&&("values"===s.closure?n.setValues([i]):"clear"===s.closure&&n.clearContent())}function format_(e,t,a,s){var r;if(void 0!==e[t])r=[t,""];else{if(r=t.match(/^(.+)\|([^\|]*)$/),null==r||null==e[r[1]])return a.push(repl_(T.statusMissingField,null==r?t:r[1])),"";r=r.slice(1)}var n=e[r[0]];try{if(1==r.length&&r.push(""),"object"==typeof n)try{n=Utilities.formatDate(n,c.tz||(c.tz=c.ss.getSpreadsheetTimeZone()),""==r[1]?ddf:r[1])}catch(i){a.push(repl_(T.statusDateFormatErr,t)),n=Utilities.formatDate(n,c.tz,ddf)}else if("number"==typeof n&&""!=r[1]&&"s"!=r[1]){var o=r[1].length-1;"%"==r[1].charAt(o)&&(n*=100,o--),r[1].charAt(o).match(/\d/)?(n=n.toFixed(+r[1].charAt(o)),o--):n=n.toString();var l=n.split("."),u=r[1].charAt(o);o--,o>=0&&"("!=r[1].charAt(o)&&(l[0]=l[0].split("").reverse().join("").match(/\d{1,3}/g).join(r[1].charAt(o)).split("").reverse().join(""),o--),"-"==n.charAt(0)&&(o>=0&&"("==r[1].charAt(o)?(l[0]="("+l[0],l[1]=l[1]+")"):l[0]="-"+l[0]),n=l.join(u)}else n=n.toString(),""!=r[1]&&"s"==r[1].charAt(0)&&("U"==r[1].charAt(1)?n=n.toUpperCase():"D"==r[1].charAt(1)?n=n.toLowerCase():"P"==r[1].charAt(1)&&n.length>0&&(n=n.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}))),!s||""!=r[1]&&"H"==r[1].charAt(1)||(n=n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"))}catch(i){a.push(repl_(T.statusFormattingErr,t))}return n}function processManually(){if(loadOrDefaults_()){var e=showInput_(T.manualQuestion);if("cancel"==e)return null;var t=!1;"*"==e.charAt(e.length-1)&&(t=!0,e=e.substring(0,e.length-1));var a=parseInt(e),r=c.fs.getLastRow();if(isNaN(a))return showMsg_(repl_(T.manualInvalid,e));if(2>a){if(!t)return showMsg_(T.manual1stSingle);a=2,showMsg_(T.manual1stMult)}else if(a>r)return showMsg_(T.manualAfterLast);t||(r=a);for(var n=!1,i=a;r>=i;i++){if(s.quota<=s.qLimit)return showMsg_(repl_(T.manualQuotaLimit,i));if(s.quota<=s.qWarn&&!n&&(n="yes"==showMsg_(T.manualQuotaWarn,"YES_NO"),!n))return null;doIt_(i)}showMsg_(0==c.err.length?repl_(r>a?T.manualSuccessMult:T.manualSuccessSingle,a,r):T.manualErrors)}}function checkTrigger_(e){var t=e||(new Date).getTime()-+sget_("lastRun",0)<6e4,a=c.cs.getRange("B2");a.getValue()!=(t?T.yes:T.no)&&(t?a.setValue(T.yes).setFontColor("#008000"):a.setValue(T.no).setFontColor("#993300"))}function settings(){if(loadOrDefaults_()){for(var e=UiApp.createApplication().setTitle(repl_(T.title,NAME)).setWidth(_appSize[0]).setHeight(_appSize[1]),t=e.createDecoratedTabPanel().setId("tabPanel"),a={insert:e.createServerClickHandler("insertQuestion_").addCallbackElement(t),link:e.createServerClickHandler("linkClick_"),save:e.createServerClickHandler("save_").addCallbackElement(t)},r=[],n=0;n<s.qtt;n++)r.push(createEmailTab_(e,n,a));1==s.qtt&&(r[0].name=repl_(T.emailTab,""));for(var i=e.createGrid(ap.length,3),o=0;o<ap.length-2;o++)i.setWidget(o,0,createLabel_(e,T[ap[o]]+":")).setWidget(o,1,createTextBox_(e,ap[o])).setWidget(o,2,e.createLabel(T[ap[o]+"DESC"]));for(var l=css_(e.createListBox().setName(ap[o]),{i:textParam,fontSize:_placeHolders.fontSize}),u=[["formulas",T.closureFormulas],["values",T.closureValues],["clear",T.closureClear]],n=0;n<u.length;++n)l.addItem(u[n][1],u[n][0]),s[ap[o]]===u[n][0]&&l.setSelectedIndex(n);i.setWidget(o,0,createLabel_(e,T[ap[o]]+":")).setWidget(o,1,l).setWidget(o,2,e.createLabel(T[ap[o]+"DESC"])),o++,i.setWidget(o,0,createLabel_(e,T[ap[o]]+":")).setWidget(o,1,createTextBox_(e,ap[o]).setEnabled(!1)).setWidget(o,2,e.createLabel(T[ap[o]+"DESC"]));var p=e.createButton(T.saveAndClose).addClickHandler(a.save);r.push({name:T.advTab,tab:e.createVerticalPanel().setSpacing(10).add(e.createLabel(T.advIntro).setStyleAttribute("fontWeight","bold")).add(i).add(e.createLabel(repl_(T.advTip1,T.saveAndClose))).add(e.createLabel(" ")).add(e.createLabel(repl_(T.advTip2,NAME))).add(e.createHorizontalPanel().add(e.createLabel(T.advTip3+nbs)).add(e.createAnchor("sites.google.com/site/FormEmailer","http://sites.google.com/site/formemailer"))).add(p).setCellHorizontalAlignment(p,UiApp.HorizontalAlignment.CENTER)});for(var n in r)t.add(r[n].tab.setSize("100%","100%"),r[n].name);t.selectTab(0).setAnimationEnabled(!0),e.add(t.setSize("100%","100%")),c.ss.show(e)}}function createEmailTab_(e,t,a){var r=e.createListBox().setName("question"+t);for(var n in c.questions)r.addItem(c.questions[n]);for(var i=e.createVerticalPanel().setSpacing(0).setWidth("100%").setHorizontalAlignment(UiApp.HorizontalAlignment.RIGHT).add(e.createGrid(1,2).setCellPadding(0).setCellSpacing(0).setWidget(0,0,createLabel_(e,T.placeholders)).setWidget(0,1,css_(r,_placeHolders))),o=e.createGrid(ef.length-1,2).setCellSpacing(0).setCellPadding(0).setId("grid").setWidth("100%"),l=e.createHorizontalPanel().setSpacing(3).add(e.createLabel(msg_(T.addField))),n=0;n<ef.length-2;n++){var u=""!=s[ef[n]+t]||2==n;o.setWidget(n,0,createLabel_(e,T[ef[n]]+":",ef[n]+t+":").setVisible(u)).setWidget(n,1,e.createGrid(1,2).setId("box"+ef[n]+t).setWidth("100%").setCellPadding(0).setCellSpacing(0).setWidget(0,0,createTextBox_(e,ef[n]+t,_emailField)).setWidget(0,1,createLabel_(e,unescape("%u2190%20")+T.insertPlaceholder+nbs,"ip"+ef[n]+t,a.insert)).setVisible(u)),u||l.add(createLabel_(e,T[ef[n]].replace(" ",""),"link"+ef[n]+t,a.link))}var p=e.createCheckBox(T.html+nbs).setValue("true"==s["html"+t]).setName("html"+t),d=e.createHorizontalPanel().setSize("100%",_body.height).setVerticalAlignment(UiApp.VerticalAlignment.TOP).add(e.createVerticalPanel().setWidth("100%").setHorizontalAlignment(UiApp.HorizontalAlignment.RIGHT).add(css_(createLabel_(e,T.body+":"),{marginTop:"5px"})).add(p.setWidth("100%")));o.setWidget(ef.length-2,0,d).setWidget(ef.length-2,1,css_(e.createTextArea().setText(s["body"+t]).setId("body"+t).setName("body"+t),_body));var g=e.createButton(T.saveAndClose).addClickHandler(a.save),h=(_appSize[0]-180)/2,m=e.createHorizontalPanel().setWidth("100%").add(l).setCellWidth(l,h+"px").add(g).setCellWidth(g,_appSize[0]-2*h-15+"px").setCellHorizontalAlignment(g,UiApp.HorizontalAlignment.CENTER).add(createLabel_(e,unescape("%u2191%20")+T.insertPlaceholder+nbs,"ipbody"+t,a.insert).setWidth(h+"px"));return{name:repl_(T.emailTab,t+1),tab:css_(e.createVerticalPanel().add(i).add(o).add(m),{width:"100%",maxWidth:_appSize[0]+"px"})}}function linkClick_(e){var t=UiApp.getActiveApplication(),a=e.parameter.source.substr(4);return t.getElementById("box"+a).setVisible(!0),t.getElementById(a+":").setVisible(!0),t.getElementById("link"+a).setVisible(!1),t}function insertQuestion_(e){var t=UiApp.getActiveApplication(),a=e.parameter.source.substr(2),s=a.match(/\d*$/),r=e.parameter[a]+"#"+e.parameter["question"+s]+"#";return t.getElementById(a).setText(r).setFocus(!0),t}function save_(e){var t=UiApp.getActiveApplication();c.ss=SpreadsheetApp.getActiveSpreadsheet(),c.cs=c.ss.getSheetByName(NAME);var a=c.cs.getRange("B3");T=JSON.parse(a.getValue()).T;for(var r in ap)s[ap[r]]=e.parameter[ap[r]];for(var n=0;void 0!==e.parameter["to"+n];n++)for(var r in ef)s[ef[r]+n]=e.parameter[ef[r]+n];c.ss=SpreadsheetApp.getActiveSpreadsheet();var i="fSheet";if(c.fs=c.ss.getSheetByName(s[i]),null==c.fs)return showErrorDialog_(t,n,i,T.sheetError);s[i]=c.fs.getName();var o={qtt:1,qWarn:0,qLimit:0};for(var i in o){var l=parseInt(s[i].match(/^\d+$/));if(isNaN(l)||l<o[i]||"qtt"==i&&l>10)return showErrorDialog_(t,n,i,T.numberError);s[i]=l}if(i="fLoc",""!=s[i]){var u=s[i].lastIndexOf("!");if(-1==u)return showErrorDialog_(t,n,i,T.formulasError);var p=s[i].substr(0,u);if(c.fl=p==s.fSheet?c.fs:c.ss.getSheetByName(p),null==c.fl)return showErrorDialog_(t,n,i,T.formulasSheetError);for(var d=c.fl.getMaxColumns(),g=s[i].substr(u+1).split(":"),r=0;r<g.length;r++)if(g[r].match(/^[a-zA-Z]{1,2}2?$/)){var h=g[r].length-1;if(g[r]=changeColumnNotation_("2"==g[r].charAt(h)?g[r].substr(0,h):g[r],!0),g[r]>d)return showErrorDialog_(t,n,i,T.formulasColsError)}1==g.length&&g.push(g[0]),s[i]=c.fl.getName()+"!"+changeColumnNotation_(g[0],!1)+":"+changeColumnNotation_(g[1],!1)}c.size=c.fs.getLastColumn()-1,c.questions=parseQuestions_(c.fs.getRange(1,2,1,c.size).getValues()[0]);for(var r=s.qtt-1;r>0&&null==s[ef[0]+r];r--)createDefaultEmail_(r);return delete s.quota,s.Version=VERSION,a.setValue(JSON.stringify({s:s,T:T})),t.close(),t}function showErrorDialog_(e,t,a,s){return e.getElementById("tabPanel").setVisible(!1).selectTab(t),e.add(css_(e.createDialogBox(!1,!0).setId("errorDialog").setText(T.errorTitle),{position:"fixed",top:"30%",left:"35%"}).add(e.createVerticalPanel().add(e.createLabel(repl_(s,T[a]))).add(e.createLabel(T.badSettings)).add(e.createButton(T.ok,e.createServerClickHandler("closeDialog_")).setId("focus"+a)))),e}function closeDialog_(e){var t=UiApp.getActiveApplication();return t.getElementById("errorDialog").setVisible(!1),t.getElementById("tabPanel").setVisible(!0),t.getElementById(e.parameter.source.substr(5)).setFocus(!0),t}function loadConfig_(){c.ss=c.ss||SpreadsheetApp.getActiveSpreadsheet(),c.cs=c.cs||getSheet_(NAME);var e=JSON.parse(c.cs.getRange("B3").getValue());s=e.s,T=e.T,sVersion=+s.Version;var t=3.6;if(isNaN(sVersion)||sVersion<t||sVersion>VERSION)throw repl_(T.versionConflict,s.Version,VERSION,NAME).replace(/ /g,nbs);c.origQuota=s.quota=getQuotaSecured_(),c.fs=getSheet_(s.fSheet),c.err=[],c.size=c.fs.getLastColumn()-1;var a=c.fs.getRange(1,2,1,c.size).getValues()[0];if(""!=s.fLoc){var r=s.fLoc.lastIndexOf("!"),n=s.fLoc.substr(0,r);c.fc=s.fLoc.substr(r+1).split(":");for(var i=0;2>i;i++)c.fc[i]=changeColumnNotation_(c.fc[i],!0);c.fc[1]=c.fc[1]-c.fc[0]+1;for(var i=2;4>i;i++)c.fc[i]=c.fc.length>i?+c.fc[i]:0;n==s.fSheet?c.fl=c.fs:(c.fl=c.ss.getSheetByName(n),a=a.concat(c.fl.getRange(1,c.fc[0],1,c.fc[1]).getValues()[0])),c.formulas=c.fl.getRange(2,c.fc[0],1,c.fc[1]).getFormulasR1C1()[0]}c.questions=parseQuestions_(a)}function fix(){loadOrDefaults_()&&(onOpen(),showMsg_(T.noProblem))}function loadOrDefaults_(){try{return loadConfig_(),!0}catch(e){onOpen();var t=e==repl_(T.versionConflict,s.Version,VERSION,NAME).replace(/ /g,nbs),a=UiApp.createApplication().setTitle(NAME).setHeight(140),r=a.createVerticalPanel().setHorizontalAlignment(UiApp.HorizontalAlignment.CENTER).setSpacing(10),n=a.createVerticalPanel().setHorizontalAlignment(UiApp.HorizontalAlignment.CENTER),i=a.createServerHandler("closeApp_"),o,l="install",u;if(t)u=T.resolveConflict,o=i;else{if(s.Version&&!c.fs){var p=a.createListBox().setName("fSheet"),d=c.ss.getSheets();for(var g in d){var h=d[g].getName();h!=NAME&&p.addItem(h)}l="fixSheetName_",u=a.createGrid(1,2).setWidth("100%").setWidget(0,0,a.createLabel(repl_(T.fSheetMissing,T.fSheet,s.fSheet,T.yes))).setWidget(0,1,css_(p,_placeHolders))}else u=T.badConfig;var m=repl_(T.badConfigCancel,e).replace(/ /g,nbs).split("\n");for(var g in m)n.add(a.createLabel(m[g]).setWidth("100%"));n.add(a.createButton(T.ok,i)),o=a.createClientHandler().forTargets(r).setVisible(!1).forTargets(n).setVisible(!0)}return r.setWidth("100%").add("string"==typeof u?a.createLabel(repl_(u,s.Version,VERSION,NAME)):u).add(a.createFlowPanel().add(a.createButton(T.yes,a.createServerHandler(l).addCallbackElement(r))).add(a.createButton(T.no,o))),c.ss.show(a.add(r).add(n.setVisible(!1))),!1}}function fixSheetName_(e){c.ss=SpreadsheetApp.getActiveSpreadsheet(),c.cs=getSheet_(NAME);var t=c.cs.getRange("B3"),a=JSON.parse(t.getValue());return a.s.fSheet=e.parameter.fSheet,t.setValue(JSON.stringify(a)),onOpen(),closeApp_()}function closeApp_(){return UiApp.getActiveApplication().close()}function parseQuestions_(e){for(var t={},a=0;a<e.length;a++)e[a]=e[a].toString(),e[a]=e[a].length>70?e[a].substr(0,70)+"...":e[a],void 0!==t[e[a]]?(1==t[e[a]].length&&(e[t[e[a]][0]]+="("+changeColumnNotation_(t[e[a]][0]+2,!1)+")"),t[e[a]].push(a),e[a]+="("+changeColumnNotation_(a+2,!1)+")"):t[e[a]]=[a];return e}function changeColumnNotation_(e,t){if(t){var a=e.toUpperCase(),s=a.charCodeAt(0)-64;return a.length>1?26*s+a.charCodeAt(1)-64:s}var r=function(e){return String.fromCharCode(e+64)};return 27>e?r(e):r(Math.floor((e-1)/26))+r((e-1)%26+1)}function createDefaults_(){s.Version=VERSION;var e=[c.fs.getName(),1,150,30,"",T.closureValues];for(var t in e)s[ap[t]]=e[t];c.questions=parseQuestions_(c.fs.getRange(1,2,1,c.fs.getLastColumn()-1).getValues()[0]),createDefaultEmail_(0)}function createDefaultEmail_(e){var t="user@example.com";try{t=Session.getEffectiveUser().getEmail()}catch(a){}for(var r=T.defaultBody+"<br>\n<b>"+c.questions[0]+": </b>#"+c.questions[0]+"|M/d/yyyy H:mm:ss#<br>\n",n=1;n<c.questions.length;n++)r+="<b>"+c.questions[n]+": </b>#"+c.questions[n]+"#<br>\n";var i=[NAME,"",t,"","",T.defaultSubject,r,"true"];for(var n in ef)s[ef[n]+e]=i[n]}function install(e){var overwrite=void 0!==e?!0:!1,app=UiApp.createApplication().setTitle(NAME).setWidth(520).setHeight(180);c.ss=c.ss||SpreadsheetApp.getActiveSpreadsheet();var langDefinitionUrl="https://sites.google.com/site/formemailer/translate/languages.txt?attredirects=0&d=1",langs=UrlFetchApp.fetch(langDefinitionUrl).getContentText().split("\n"),locale=SpreadsheetApp.getActive().getSpreadsheetLocale(),myLang=locale.split("_")[0],found=!1,langList=css_(app.createListBox().setName("language"),_placeHolders),langMap={},langCompat=0,firstLang=null,count=0;for(var i in langs){var csv=langs[i].split(",");if("versions"==csv[0]){langCompat=0;for(var j=1;j<csv.length;++j){if(+csv[j]==VERSION){langCompat=1;break}+csv[j]<VERSION&&(langCompat=2)}}else 0!=langCompat&&void 0===langMap[csv[0]]&&(langMap[csv[0]]=1,null===firstLang&&(firstLang=csv[2]),langList.addItem(csv[1]+(1==langCompat?"":"*"),langCompat+","+csv[2]),(csv[0]==locale||!found&&csv[0].split("_")[0]==myLang)&&(found=csv[2],langList.setSelectedIndex(count)),++count)}eval("pack="+UrlFetchApp.fetch(found||firstLang).getContentText());for(var i in pack)T[i]=pack[i];var sheetList=css_(app.createListBox().setName("fSheet"),_placeHolders),sheets=c.ss.getSheets();found=!1;for(var i in sheets){var name=sheets[i].getName();name!=NAME?sheetList.addItem(name):found=!0}var panel=app.createVerticalPanel().setHorizontalAlignment(UiApp.HorizontalAlignment.CENTER).setSpacing(5);panel.add(app.createGrid(2,2).setWidget(0,0,app.createLabel(T.pickLanguage).setId("pickLanguage")).setWidget(0,1,langList.addChangeHandler(app.createServerHandler("langChange_").addCallbackElement(langList))).setWidget(1,0,app.createLabel(T.pickSheet).setId("pickSheet")).setWidget(1,1,sheetList)).add(css_(app.createLabel(T.langIncomplete).setId("langIncomplete").setVisible(!1),{fontStyle:"italic"}));var button=app.createButton(T.install,app.createServerHandler("proceedInstall_").addCallbackElement(panel)).setId("install");panel.add(app.createCheckBox(repl_(T.overwrite,NAME)).setName("overwrite").setId("overwrite").setValue(overwrite).setVisible(found).addValueChangeHandler(app.createClientHandler().forTargets(button.setEnabled(!found||overwrite)).setEnabled(!1)).addValueChangeHandler(app.createServerHandler("overwrite_").addCallbackElement(panel))),panel.add(button),c.ss.show(app.add(panel))}function langChange_(e){try{var app=UiApp.getActiveApplication(),lang=e.parameter.language.split(",");eval("pack="+UrlFetchApp.fetch(lang[1]).getContentText());for(var update=["pickLanguage","pickSheet","install","overwrite","langIncomplete"],i=0;i<update.length;++i)app.getElementById(update[i]).setText(repl_(void 0===pack[update[i]]?T[update[i]]:pack[update[i]],NAME));app.getElementById("langIncomplete").setVisible("2"==lang[0])}catch(err){app.add(app.createLabel(String(err)))}return app}function overwrite_(e){var t=UiApp.getActiveApplication();return"true"==e.parameter.overwrite&&t.getElementById("install").setEnabled(!0),t}function proceedInstall_(e){eval("pack="+UrlFetchApp.fetch(e.parameter.language.split(",")[1]).getContentText());for(var i in pack)T[i]=pack[i];if(c.ss=SpreadsheetApp.getActiveSpreadsheet(),c.fs=getSheet_(e.parameter.fSheet),0==c.fs.getLastColumn()){var app=UiApp.createApplication().setTitle(NAME).setHeight(100);return app.add(app.createVerticalPanel().setHorizontalAlignment(UiApp.HorizontalAlignment.CENTER).add(app.createLabel(repl_(T.blankSheet,c.fs.getName()))).add(app.createButton(T.ok,app.createServerHandler("closeApp_")))),c.ss.show(app)}var col=c.fs.getRange(1,1),val=col.getValue(),status1=repl_(T.statusColumn,NAME),status2=NAME+" Status",relocateStatus=!1;if(val!=status1)if(val!=status2){c.fs.insertColumnBefore(1).setColumnWidth(1,133).getRange(1,1).setValue(status1).setComment(T.statusComment);var lastCol=c.fs.getLastColumn();if(val=c.fs.getRange(1,lastCol).getValue(),val==status1||val==status2){relocateStatus=!0;var qttRows=c.fs.getLastRow()-1;c.fs.getRange(2,lastCol,qttRows,1).moveTo(c.fs.getRange(2,1,qttRows,1)),c.fs.deleteColumn(lastCol)}}else col.setValue(status1);createDefaults_(),c.cs=c.ss.getSheetByName(NAME),null!=c.cs?c.cs.clear():c.cs=c.ss.insertSheet(NAME);var header=repl_(T.header,NAME).split("\n"),prepare=[];for(var i in header)prepare.push([header[i]]);c.cs.getRange("A1:A3").setValues(prepare);var instructions=repl_(T.instructions,T.fSheet).split("\n");prepare=[];var boldLine=6;for(var i in instructions)prepare.push([instructions[i],""]),6==boldLine&&""==instructions[i]&&(boldLine+=+i);if(c.cs.getRange(5,1,instructions.length,2).setValues(prepare).mergeAcross().setWrap(!0),c.cs.getRange("A1:B1").mergeAcross().setHorizontalAlignment("center").setFontSize(14),c.cs.getRange("B2").setValue("No").setFontColor("#993300").setHorizontalAlignment("left").setFontWeight("bold"),c.cs.getRange("B3").setWrap(!1).setValue(JSON.stringify({s:s,T:T})).setComment(T.settingsComment),c.cs.getRange("C3").setValue(" "),c.cs.getRange("A5").setFontWeight("bold"),c.cs.getRange(boldLine,1).setFontWeight("bold"),c.cs.setColumnWidth(1,217).setColumnWidth(2,342),onOpen(),relocateStatus){var app=UiApp.createApplication().setTitle(NAME).setHeight(100);return app.add(app.createVerticalPanel().setHorizontalAlignment(UiApp.HorizontalAlignment.CENTER).add(app.createLabel(repl_(T.relocateStatus,c.fs.getName()))).add(app.createButton(T.ok,app.createServerHandler("closeApp_")))),c.ss.show(app)}return UiApp.getActiveApplication().close()}function createLabel_(e,t,a,s){var r=css_(e.createLabel(t,!1),_right);return null!=a&&r.setId(""==a?t:a),void 0!==s&&css_(r.addClickHandler(s),_link),r}function createTextBox_(e,t,a){return css_(e.createTextBox().setId(t).setName(t).setText(s[t]+""),a||("string"==typeof s[t]?textParam:numParam))}function getSheet_(e){var t=c.ss.getSheetByName(e);if(null==t)throw"cancel"==e?T.cancelMessage:repl_(T.missingSheet,e+"");return t}function getQuotaSecured_(){try{return MailApp.getRemainingDailyQuota()}catch(e){return 500}}function errorHandling_(e,t){var a=(new Date).getTime();sset_("lastRun",a);var r=+sget_("filterRnd","0");if(4>r)try{e(t)}catch(n){return sset_("filterRnd",r+1)}else e(t);0!=r&&sset_("filterRnd",0);var i=s.quota<s.qWarn;c.err.length>0?(MailApp.sendEmail(Session.getEffectiveUser().getEmail(),repl_(T.errorReportSubject,NAME),repl_(T.errorReportBody,c.ss.getName(),c.err.join("\n"))+(i?T.alsoQuota:"")+"\n\n"+c.ss.getUrl()),i&&uset_("quota.lastWarning",a)):c.origQuota!=s.quota&&i&&a-+uget_("quota.lastWarning",""+a)>864e5&&(MailApp.sendEmail(Session.getEffectiveUser().getEmail(),repl_(T.quotaMailSubject,NAME),repl_(T.quotaMailBody,s.quota,s.qWarn)+"\n\n"+c.ss.getUrl()),uset_("quota.lastWarning",a))}function css_(e,t){for(var a in t)"object"==typeof t[a]?css_(e,t[a]):e.setStyleAttribute(a,t[a]);return e}function showMsg_(e,t){return Browser.msgBox(NAME,msg_(e),Browser.Buttons[t||"OK"])}function showInput_(e,t){return Browser.inputBox(NAME,msg_(e),Browser.Buttons[t||"OK_CANCEL"])}function msg_(e){return e.toString?e.toString().replace(/ /g,nbs).replace(/\n/g,"\\n"):e}function repl_(){var e=arguments;return e[0].replace(/{(\d+)}/g,function(t,a){return"undefined"!=typeof e[a]?e[a]:t})}function startsWith_(e,t){return e.length>=t.length&&e.substr(0,t.length)===t}function sget_(e,t){return get_(ScriptProperties,e)||t}function sset_(e,t){set_(ScriptProperties,e,t)}function uget_(e,t){return get_(UserProperties,e)||t}function uset_(e,t){set_(UserProperties,e,t)}function set_(e,t,a){try{e.setProperty(t,a)}catch(s){}}function get_(e,t){try{return e.getProperty(t)}catch(a){return""}}var VERSION=3.65,NAME="FormEmailer",T={sender:"Sender Name",replyTo:"Reply To",to:"To",cc:"Cc",bcc:"Bcc",subject:"Subject",body:"Body",html:"html",fSheet:"Form sheet",fSheetDESC:"Name of the sheet that holds the form answers",qtt:"Qtt Emails",qttDESC:"Max quantity of emails sent per form submitted",qWarn:"Quota warning",qWarnDESC:"Daily quota threshold that will trigger a warning email",qLimit:"Quota limit",qLimitDESC:"Quota minimum value where FormEmailer will stop sending emails",fLoc:"Formulas location",fLocDESC:"Enter the location using the format: SheetName!A:B",closure:"Closure mode",closureDESC:"What the script should do after your formulas are evaluated",closureValues:"values",closureFormulas:"formulas",closureClear:"clear",quota:"Remaining quota",quotaDESC:"Amount of your daily quota you got left now",menuSettings:"Settings",menuManually:"Process manually",menuAbout:"About",menuFix:"Fix",version:"{1} - version {2}",about1:"Script developed by {1}",about2:"Help, samples and tutorials can be found at",statusEmail:"Email{1} sent",statusNot:"Email{1} not sent",statusError:"Error sending email{1}: {2}",mailError:"Error sending email{1} on line{3}: {2}",statusQuota:"Quota limit reached",statusMissingField:"Field does not exist: {1}",statusFormattingErr:"Error formatting field: {1}",statusDateFormatErr:"Error formatting date field: {1}",manualQuestion:"Which line do you want process?\nAppend an * to the line number to process from it to the end",manualInvalid:'"{1}" is not a valid number. Aborting.',manual1stMult:"The first line is the n.2. I'll consider that you want to process from the beginning.",manual1stSingle:"The line number should be equal to or greater than 2.\nSince the 1st row is the header.",manualAfterLast:"The line number you typed is beyond the last one with data.",manualQuotaWarn:"Quota warning threshold reached! Continue anyway?",manualQuotaLimit:"Quota minimum limit reached\nProcess stopped at line {1}",manualSuccessMulti:"All lines from {1} to {2} processed successfully",manualSuccessSingle:"Line {1} processed successfully",manualErrors:"There were some errors on the processing, check out the rows status",yes:"Yes",no:"No",ok:"Ok",title:"{1} Settings",emailTab:"Email{1}",advTab:"Advanced",advIntro:"You don't need to worry with these settings if you don't want to.",advTip1:"*You have to '{1}' and re-open to see the updates on any changes you make here.",advTip2:"Having doubts with these parameters? Want to learn more about {1}?",advTip3:"Access the help site at",placeholders:"Answers placeholders:",addField:"Add field:",insertPlaceholder:"insert placeholder",saveAndClose:"Save and Close",sheetError:"{1} informed does not exist!",numberError:"{1} is not a valid number!",formulasError:"Invalid {1}",formulasSheetError:"Invalid sheet for {1}",formulasColsError:"Invalid column reference for {1}",errorTitle:"Error",badSettings:"Your data was not saved.",versionConflict:"Config version is {1}, but script's is {2}. They are not compatible.\n",resolveConflict:'You settings version "{1}", is not compatible with the script\'s version "{2}". Do you want to overwrite it new default settings?',badConfig:"Your config is damaged or missing!\nDo you want to overwrite it with the default values?",badConfigCancel:"Nothing done.\nHere is the error message:\n{1}",noProblem:"There seem to be no problem with your settings.",missingSheet:"Unable to find sheet: {1}",fSheetMissing:'Your "{1}: {2}" cannot be found, please choose a new one and click "{3}" to fix',cancelMessage:"Canceled",errorReportSubject:"{1} errors report",errorReportBody:'The following errors occurred on "{1}" spreadsheet:\n{2}',alsoQuota:"Also, your quota is below the warning limit",quotaMailSubject:"{1} quota warning",quotaMailBody:"Your actual quota is: {1}\nIt is bellow the warning threshold: {2}",pickLanguage:"Select a language:",langIncomplete:"This language was written for an older version of the script and is probably incomplete.",pickSheet:"Select the sheet that has your form answers (or data to be merged):",install:"Install",overwrite:'Do you confirm you want to overwrite your whole "{1}" sheet?',defaultBody:"Submitted values:",defaultSubject:"New form submitted",blankSheet:'Your "{1}" sheet is blank! Please create your form or basic data structure before installing, so the script can create nice defaults for you.',statusColumn:"{1} Status",relocateStatus:"In this new version of the script, the status column is the 1st instead of last. I have moved it for you, please verify.",statusComment:"This column must always be the first one",settingsComment:"Please do NOT modify this manually! Use the Settings interface",header:"{1}\nRunning automatically:\nYour settings are save here:",instructions:'Settings tips:\nIf you want to rename your form sheet, remember to rename the "{1}" parameter at the same time.\nA very good practice is to have the first row of data with some bogus values so you can make some tests before running it on the whole data set.\nThe placeholders may be used in any field, e.g. To, Subject, etc.\nThe "#" character is used to delimit the placeholders\' boundaries, if you want to use this char in any field, write it two times "##". They will be replace by only one.\nYou may provide formatting instructions in the placeholder by using the "|" char after the field name. Take a look at the available format in the help site.\nhttp://sites.google.com/site/FormEmailer\n\nNew install instructions:\nYou need to set up the trigger so the script can run automatically. Steps:\n- Click the menu "Tools" > "Script editor..."\n- In the editor\'s window\n-- Make sure the {1} script is opened and selected (it normally is)\n-- Click the menu "Triggers" > "Current script\'s triggers..."\n--- Click the only link and set up a new trigger as follows:\ntimeDriven - Time-driven - Minutes timer - Every minute\n--- Click save\n-- You may close the editor\nThe status indication in this sheet (cell B2) may take some minutes to update.'},ef="sender,replyTo,to,cc,bcc,subject,body,html".split(","),ap="fSheet,qtt,qWarn,qLimit,fLoc,closure,quota".split(","),s={},c={},ddf="M/d/yyyy H:mm:ss",nbs=unescape("%A0"),_appSize=[760,480],_emailField={width:"480px",fontSize:"12px"},_body={height:"234px",minHeight:"234px",maxHeight:"234px",width:"100%",minWidth:"100%",maxWidth:"100%"},_placeHolders={width:"230px",fontSize:"12px"},_link={color:"blue",cursor:"hand"},_right={width:"100%",textAlign:"right"},numParam={width:"70px",textAlign:"right"},textParam={width:"150px"};